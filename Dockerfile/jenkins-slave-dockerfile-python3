FROM informaticsmatters/jenkins-slave-python3-centos7:3.7

MAINTAINER robin.chen@percolata.com

USER root

ENV PYTHON_VERSION 3.6
ENV DEBIAN_FRONTEND noninteractive

RUN pip install --upgrade pip
RUN pip install cmake

WORKDIR /
ENV OPENCV_VERSION="4.0.1"
RUN wget https://github.com/opencv/opencv_contrib/archive/${OPENCV_VERSION}.zip \
&& unzip ${OPENCV_VERSION}.zip \
&& rm ${OPENCV_VERSION}.zip
RUN wget https://github.com/opencv/opencv/archive/${OPENCV_VERSION}.zip \
&& unzip ${OPENCV_VERSION}.zip \
&& mkdir /opencv-${OPENCV_VERSION}/cmake_binary \
&& cd /opencv-${OPENCV_VERSION}/cmake_binary \
&& cmake -DBUILD_TIFF=ON \
  -DBUILD_opencv_java=OFF \
  -DOPENCV_EXTRA_MODULES_PATH=/opencv_contrib-${OPENCV_VERSION}/modules \
  -DWITH_CUDA=OFF \
  -DWITH_OPENGL=ON \
  -DWITH_OPENCL=ON \
  -DWITH_IPP=ON \
  -DWITH_TBB=ON \
  -DWITH_EIGEN=ON \
  -DWITH_V4L=ON \
  -DBUILD_TESTS=OFF \
  -DBUILD_PERF_TESTS=OFF \
  -DCMAKE_BUILD_TYPE=RELEASE \
  -DCMAKE_INSTALL_PREFIX=$(python3.6 -c "import sys; print(sys.prefix)") \
  -DPYTHON_EXECUTABLE=$(which python3.6) \
  -DPYTHON_INCLUDE_DIR=$(python3.6 -c "from distutils.sysconfig import get_python_inc; print(get_python_inc())") \
  -DPYTHON_PACKAGES_PATH=$(python3.6 -c "from distutils.sysconfig import get_python_lib; print(get_python_lib())") \
  .. \
&& make install \
&& rm /${OPENCV_VERSION}.zip \
&& rm -r /opencv-${OPENCV_VERSION}

# add bitbuckets key
ADD id_rsa-bitbucket-backend /root/.ssh/id_rsa
RUN chmod 600 /root/.ssh/id_rsa

# Create known_hosts
RUN touch /root/.ssh/known_hosts

# Add bitbuckets key
RUN ssh-keyscan bitbucket.org >> /root/.ssh/known_hosts
RUN pip install git+ssh://git@bitbucket.org/percolata/backend-common.git@master#egg=backend_common

RUN pip install numpy==1.16.2 redis==2.10.6
RUN pip install graypy[amqp]==0.3.1
RUN pip install mysql-connector-python==8.0.13 pyspark==2.3.1 scikit-learn==0.20.1
RUN pip install pandas pygsheets requests==2.20.1 pymysql pyarrow==0.13.0
RUN pip install python-dateutil==2.7.5
RUN pip install azure-mgmt-datalake-store==0.5.0
RUN pip install azure-datalake-store==0.0.39
RUN pip install azure-mgmt-resource==2.0.0
RUN pip install azure.storage==0.20.0
RUN pip install configparser==3.5.0b2
RUN pip install coverage pyyaml slackclient
RUN pip install pyecharts==0.5.11 pyecharts-snapshot==0.1.10 matplotlib==3.0.3
RUN pip install pandas-gbq google-cloud-storage google-cloud-bigquery google-api-python-client
RUN pip install --upgrade git+https://github.com/m-wrzr/populartimes


#RUN virtualenv $HOME/venv && \
#    . $HOME/venv/bin/activate && \
#    pip3 install -U pip

#ENV ENV $HOME/venv/bin/activate
#ENV BASH_ENV $HOME/venv/bin/activate

#RUN chown -R jenkins:jenkins $HOME && \
#    chmod -R g+rw $HOME



