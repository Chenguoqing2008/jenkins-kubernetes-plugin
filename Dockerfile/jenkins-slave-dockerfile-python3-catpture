FROM jenkins/jnlp-slave

MAINTAINER robin.chen@percolata.com

ENV PYTHON_VERSION 3.5
ENV DEBIAN_FRONTEND noninteractive

USER root 

RUN apt-get update \
    && apt-get dist-upgrade -y \
    && apt-get -y install python${PYTHON_VERSION} \
       libffi-dev libpq-dev libssl-dev python3-dev \
       python3-pip python3-venv \
       python3-wheel build-essential \
    && rm -rf /var/lib/apt/lists/* \
    && ln -nsf /usr/bin/python3 /usr/bin/python
RUN pip3 install --upgrade pip

# install requirements
RUN pip3 install pymysql
RUN apt-get install curl
RUN apt update
RUN apt install ffmpeg -y

# install MP4Box
RUN git clone https://github.com/gpac/gpac.git

WORKDIR gpac
RUN ./configure --static-mp4box --use-zlib=no
RUN make -j4
RUN make install
COPY libevAPI.so /usr/lib/

# make ssh dir
RUN mkdir -p /root/.ssh

# add bitbuckets key
ADD id_rsa-bitbucket-backend /root/.ssh/id_rsa
RUN chmod 600 /root/.ssh/id_rsa
# RUN echo "$ssh_prv_key" > /root/.ssh/id_rsa && chmod 600 /root/.ssh/id_rsa

# Create known_hosts
RUN touch /root/.ssh/known_hosts

# Add bitbuckets key
RUN pip3 install --upgrade setuptools
RUN pip3 install idna==2.5
RUN pip3 install pyasn1==0.4.1
RUN pip3 install pandas-gbq google-cloud-storage google-cloud-bigquery google-api-python-client
RUN pip3 install coverage google-cloud-bigquery-storage pandas-gbq
RUN ssh-keyscan bitbucket.org >> /root/.ssh/known_hosts
RUN pip install git+ssh://git@bitbucket.org/percolata/backend-common.git@master#egg=backend_common



